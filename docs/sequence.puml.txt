' =============================================================================
' DOKUMENTASI SEQUENCE DIAGRAM - FACE RECOGNITION / SKIN ANALYSIS APP
' Format: PlantUML (dapat digunakan di plantuml.com atau PlantText)
' =============================================================================

' -----------------------------------------------------------------------------
' 1. Sequence Diagram - Melakukan Analisis Kulit (Karyawan/User)
' -----------------------------------------------------------------------------
@startuml sequence_analisis_kulit
title Sequence Diagram - Melakukan Analisis Kulit (Karyawan/User)

actor "Karyawan/User" as User
participant "Browser\n(Homepage)" as Browser
participant "CameraPanel" as CameraPanel
participant "skinAnalyzer\n(TensorFlow.js)" as Analyzer
participant "Face Detection\n(MediaPipe/CNN)" as FaceDetect
participant "Skin Classifier\n(CNN Model)" as Classifier
participant "API /api/analysis\n(Optional)" as API

User -> Browser: Buka halaman utama
Browser -> CameraPanel: Render CameraPanel

alt Mode: Kamera
    User -> CameraPanel: Aktifkan kamera / Ambil frame
    CameraPanel -> FaceDetect: detectFacePresenceWithCNN(video)
    FaceDetect --> CameraPanel: face detected / not
    User -> CameraPanel: Klik Capture
    CameraPanel -> Analyzer: analyzeSkin(video)
    Analyzer -> FaceDetect: Deteksi wajah
    FaceDetect --> Analyzer: bounding box
    Analyzer -> Classifier: classifySkin(frame)
    Classifier --> Analyzer: probabilities [acne, normal, oily, dry]
    Analyzer --> CameraPanel: AnalysisResult (skinType, scores)
else Mode: Upload Foto
    User -> CameraPanel: Upload gambar
    User -> CameraPanel: Klik Analyze
    CameraPanel -> Analyzer: analyzeSkin(imageElement)
    Analyzer -> Classifier: classifySkin(imageData)
    Classifier --> Analyzer: probabilities
    Analyzer --> CameraPanel: AnalysisResult
end

CameraPanel --> Browser: onCapture(result)
Browser -> Browser: setAnalysis(result)\nTampilkan ResultPanel

opt Simpan ke server (jika ada form submit)
    Browser -> API: POST /api/analysis\n(user_name, scores, ...)
    API -> API: getRecommendations(skinScores)\ncreateAnalysisLog(...)
    API --> Browser: 201 { id, dominant_condition, recommendations }
end

@enduml


' -----------------------------------------------------------------------------
' 2. Sequence Diagram - Melihat Hasil & Rekomendasi (Karyawan/User)
' -----------------------------------------------------------------------------
@startuml sequence_hasil_rekomendasi
title Sequence Diagram - Melihat Hasil & Rekomendasi (Karyawan/User)

actor "Karyawan/User" as User
participant "Browser\n(Homepage)" as Browser
participant "ResultPanel" as ResultPanel
participant "RecommendationCard" as RecCard
participant "API /api/products" as ProductsAPI
participant "Database" as DB

User -> Browser: Setelah analisis selesai
Browser -> ResultPanel: Render (skinType, scores, faceDetected)
ResultPanel --> User: Tampilkan tipe kulit, skor (oily, dry, normal, acne),\nconfidence, progress bars

Browser -> RecCard: Render (skinType)
RecCard -> ProductsAPI: GET /api/products
ProductsAPI -> DB: getAllProducts()
DB --> ProductsAPI: daftar produk + weights
ProductsAPI --> RecCard: JSON products[]

RecCard -> RecCard: slice(0, 3) atau filter by skinType
RecCard --> User: Tampilkan rekomendasi produk (nama, brand, deskripsi)

note right of RecCard
  Alternatif: jika user submit form analisis,
  POST /api/analysis mengembalikan
  recommendations langsung dari server
  (rule-based scoring)
end note

@enduml


' -----------------------------------------------------------------------------
' 3. Sequence Diagram - Login (Administrator)
' -----------------------------------------------------------------------------
@startuml sequence_login_admin
title Sequence Diagram - Login (Administrator)

actor "Administrator" as Admin
participant "Browser" as Browser
participant "Login Page\n/login" as LoginPage
participant "Middleware\n/admin/*" as Middleware
participant "authClient\n(better-auth)" as AuthClient
participant "API /api/auth" as AuthAPI
participant "Session/DB" as Session

Admin -> Browser: Akses /admin atau /login
Browser -> Middleware: Request /admin/*

alt Tidak ada session
    Middleware -> AuthAPI: GET /api/auth/session\n(Cookie)
    AuthAPI -> Session: Cek session
    Session --> AuthAPI: null
    AuthAPI --> Middleware: no session
    Middleware --> Browser: Redirect 302 â†’ /login
    Browser -> LoginPage: Tampilkan form login
end

Admin -> LoginPage: Input email & password\nKlik Sign In
LoginPage -> AuthClient: signIn.email({ email, password, callbackURL: /admin })
AuthClient -> AuthAPI: POST sign-in
AuthAPI -> Session: Verifikasi credential\nBuat session
Session --> AuthAPI: session + cookie
AuthAPI --> AuthClient: success
AuthClient --> LoginPage: redirect to callbackURL

LoginPage -> Browser: router.push("/admin")
Browser -> Middleware: Request /admin (dengan cookie)
Middleware -> AuthAPI: GET /api/auth/session
AuthAPI --> Middleware: session valid
Middleware --> Browser: Lanjut ke /admin
Browser --> Admin: Tampilkan Admin Dashboard

@enduml


' -----------------------------------------------------------------------------
' 4. Sequence Diagram - Melihat Riwayat Analisis (Administrator)
' -----------------------------------------------------------------------------
@startuml sequence_riwayat_analisis
title Sequence Diagram - Melihat Riwayat Analisis (Administrator)

actor "Administrator" as Admin
participant "Browser\n(Admin Dashboard)" as Browser
participant "Dashboard/Reports\nPage" as Page
participant "API /api/analysis-logs" as API
participant "Model\n(getAllAnalysisLogs\netc)" as Model
participant "Database\n(analysis_logs)" as DB

Admin -> Browser: Buka tab "Analyses" / Riwayat Analisis
Browser -> Page: activeTab = 'analyses'
Page -> API: GET /api/analysis-logs\n?startDate=&endDate=&condition=

API -> Model: getAnalysisLogsByDateRange(start, end)\natau getAnalysisLogsByCondition(condition)\natau getAllAnalysisLogs()
Model -> DB: SELECT * FROM analysis_logs\n[+ filter] ORDER BY created_at DESC
DB --> Model: rows
Model --> API: AnalysisLog[]
API --> Page: JSON logs

Page --> Admin: Tampilkan tabel riwayat:\nuser_name, user_age, dominant_condition,\nscores (O/D/N/A), created_at

Admin -> Page: (Opsional) Filter condition / date range
Page -> API: GET /api/analysis-logs?condition=oily&startDate=...&endDate=...
API --> Page: filtered logs
Page --> Admin: Update tabel

@enduml


' -----------------------------------------------------------------------------
' 5. Sequence Diagram - Melihat Laporan (Administrator)
' -----------------------------------------------------------------------------
@startuml sequence_melihat_laporan
title Sequence Diagram - Melihat Laporan (Administrator)

actor "Administrator" as Admin
participant "Browser\n(Admin Reports)" as Browser
participant "Reports Page" as Page
participant "getAnalysisLogsAction\ngetProductsAction" as Actions
participant "API /api/reports/summary" as SummaryAPI
participant "Model + DB" as DB

Admin -> Browser: Buka Reports / Laporan
Browser -> Page: Mount ReportsAdmin

Page -> Actions: getAnalysisLogsAction()\ngetProductsAction()\ngetSkinTypesAction()
Actions -> DB: getAllAnalysisLogs(), getAllProducts(), ...
DB --> Actions: logs, products, skinTypes
Actions --> Page: data

Page -> Page: generateMostRecommendedReport()\ngenerateMostCommonSkinTypes()\nfilter by date/condition/product
Page --> Admin: Tampilkan: total analisis, distribusi kondisi,\ntop produk ter-rekomendasi, tabel log

opt Filter tanggal
    Admin -> Page: Set startDate, endDate
    Page -> SummaryAPI: GET /api/reports/summary?startDate=&endDate=
    SummaryAPI -> DB: getAnalysisLogsByDateRange(...)
    DB --> SummaryAPI: logs
    SummaryAPI -> SummaryAPI: Hitung conditionCounts, topProducts
    SummaryAPI --> Page: { totalAnalyses, conditionDistribution, topRecommendedProducts }
    Page --> Admin: Update ringkasan
end

@enduml


' -----------------------------------------------------------------------------
' 6. Sequence Diagram - Ekspor Laporan (Administrator)
' -----------------------------------------------------------------------------
@startuml sequence_ekspor_laporan
title Sequence Diagram - Ekspor Laporan (Administrator)

actor "Administrator" as Admin
participant "Browser\n(Admin Export/Dashboard)" as Browser
participant "Export Page\natau Dashboard" as Page
participant "API export-xlsx\natau export-pdf" as ExportAPI
participant "Model + DB" as DB
participant "XLSX / PDFKit" as Generator

Admin -> Page: Klik "Export Excel" atau "Export PDF"
Page -> Browser: fetch(url, { params: startDate, endDate })

alt Export Excel
    Browser -> ExportAPI: GET /api/reports/export-xlsx?startDate=&endDate=
    ExportAPI -> DB: getAnalysisLogsByDateRange / getAllAnalysisLogs
    DB --> ExportAPI: logs
    ExportAPI -> ExportAPI: Map ke analysesData, summaryData
    ExportAPI -> Generator: XLSX.utils.book_new()\njson_to_sheet(...)\nbook_append_sheet(...)
    Generator --> ExportAPI: workbook buffer
    ExportAPI --> Browser: Response attachment\nanalysis-report-{timestamp}.xlsx
else Export PDF
    Browser -> ExportAPI: GET /api/reports/export-pdf?startDate=&endDate=
    ExportAPI -> DB: getAnalysisLogsByDateRange / getAllAnalysisLogs
    DB --> ExportAPI: logs
    ExportAPI -> Generator: PDFDocument()\ntext(...), condition distribution, recent 10
    Generator --> ExportAPI: PDF buffer
    ExportAPI --> Browser: Response attachment\nanalysis-report-{timestamp}.pdf
end

Browser --> Admin: Unduh file

@enduml


' -----------------------------------------------------------------------------
' 7. Sequence Diagram - Kelola Data Produk (Administrator)
' -----------------------------------------------------------------------------
@startuml sequence_kelola_produk
title Sequence Diagram - Kelola Data Produk (Administrator)

actor "Administrator" as Admin
participant "Browser\n(Admin Products/Dashboard)" as Browser
participant "Products Page" as Page
participant "API /api/products" as ProductsAPI
participant "API /api/products/:id" as ProductIdAPI
participant "Model\n(Products, Brands,\nIngredients)" as Model
participant "Database" as DB

Admin -> Browser: Buka Kelola Produk
Browser -> Page: fetchProducts()
Page -> ProductsAPI: GET /api/products
ProductsAPI -> Model: getAllProducts()
Model -> DB: SELECT products (+ brand, weights)
DB --> Model: products[]
Model --> ProductsAPI: products
ProductsAPI --> Page: JSON products
Page --> Admin: Tampilkan daftar produk

alt Tambah Produk
    Admin -> Page: Isi form, Klik Simpan
    Page -> ProductsAPI: POST /api/products\n{ name, brand, description, ingredients, image_url }
    ProductsAPI -> Model: getAllBrands(), getAllIngredients()\ncreateProduct(...)
    Model -> DB: INSERT product, link brand_id, ingredient weights
    DB --> Model: product id
    Model --> ProductsAPI: productId
    ProductsAPI --> Page: 201 { id }
    Page -> Page: fetchProducts()
    Page --> Admin: Refresh list
else Edit Produk
    Admin -> Page: Klik Edit, ubah data, Simpan
    Page -> ProductIdAPI: PUT /api/products/:id\n{ name, brand_id, description, ... }
    ProductIdAPI -> Model: updateProduct(id, body)
    Model -> DB: UPDATE product (recalculate weights)
    ProductIdAPI --> Page: 200 OK
    Page --> Admin: Refresh list
else Hapus Produk
    Admin -> Page: Klik Hapus, konfirmasi
    Page -> ProductIdAPI: DELETE /api/products/:id
    ProductIdAPI -> Model: deleteProduct(id)
    Model -> DB: DELETE
    ProductIdAPI --> Page: 200 OK
    Page --> Admin: Refresh list
end

@enduml


' -----------------------------------------------------------------------------
' 8. Sequence Diagram - Kelola Kandungan Produk (Administrator)
' -----------------------------------------------------------------------------
@startuml sequence_kelola_kandungan
title Sequence Diagram - Kelola Kandungan Produk (Administrator)

actor "Administrator" as Admin
participant "Browser\n(Admin Ingredients)" as Browser
participant "Ingredients Page" as Page
participant "Server Actions" as Actions
participant "Model\n(Ingredients CRUD)" as Model
participant "Database\n(ingredients)" as DB

Admin -> Browser: Buka Kelola Kandungan / Ingredients
Browser -> Page: Mount IngredientsAdmin
Page -> Actions: getIngredientsAction()
Actions -> Model: getAllIngredients()
Model -> DB: SELECT * FROM ingredients
DB --> Model: ingredients[]
Model --> Actions: Ingredient[]
Actions --> Page: data
Page --> Admin: Tampilkan tabel kandungan (name, effect, w_oily, w_dry, w_normal, w_acne)

alt Tambah Kandungan
    Admin -> Page: Klik Tambah, isi form, Submit
    Page -> Actions: createIngredientAction({ name, effect, w_oily, w_dry, w_normal, w_acne })
    Actions -> Model: createIngredient(data)
    Model -> DB: INSERT ingredients
    Actions --> Page: { success, id }
    Page -> Page: fetchData()
    Page --> Admin: Refresh list
else Edit Kandungan
    Admin -> Page: Klik Edit, ubah bobot, Submit
    Page -> Actions: updateIngredientAction(id, formData)
    Actions -> Model: updateIngredient(id, data)
    Model -> DB: UPDATE ingredients
    Actions --> Page: { success }
    Page --> Admin: Refresh list
else Hapus Kandungan
    Admin -> Page: Klik Hapus, konfirmasi
    Page -> Actions: deleteIngredientAction(id)
    Actions -> Model: deleteIngredient(id)
    Model -> DB: DELETE
    Actions --> Page: { success }
    Page --> Admin: Refresh list
end

@enduml


' -----------------------------------------------------------------------------
' 9. Sequence Diagram - Kelola Brand Produk (Administrator)
' -----------------------------------------------------------------------------
@startuml sequence_kelola_brand
title Sequence Diagram - Kelola Brand Produk (Administrator)

actor "Administrator" as Admin
participant "Browser\n(Admin Brands)" as Browser
participant "Brands Page" as Page
participant "Server Actions" as Actions
participant "Model\n(Brands CRUD)" as Model
participant "Database\n(brands)" as DB

Admin -> Browser: Buka Kelola Brand / Brands
Browser -> Page: Mount BrandsAdmin
Page -> Actions: getBrandsAction()
Actions -> Model: getAllBrands()
Model -> DB: SELECT * FROM brands
DB --> Model: brands[]
Model --> Actions: Brand[]
Actions --> Page: data
Page --> Admin: Tampilkan tabel brand (name, logo_url)

alt Tambah Brand
    Admin -> Page: Klik Tambah, isi name & logo_url, Submit
    Page -> Actions: createBrandAction({ name, logo_url })
    Actions -> Model: createBrand(data)
    Model -> DB: INSERT brands
    Actions --> Page: { success, id }
    Page -> Page: fetchData()
    Page --> Admin: Refresh list
else Edit Brand
    Admin -> Page: Klik Edit, ubah name/logo, Submit
    Page -> Actions: updateBrandAction(id, { name, logo_url })
    Actions -> Model: updateBrand(id, data)
    Model -> DB: UPDATE brands
    Actions -> Actions: revalidatePath /admin/brands, /admin/products
    Actions --> Page: { success }
    Page --> Admin: Refresh list
else Hapus Brand
    Admin -> Page: Klik Hapus, konfirmasi
    Page -> Actions: deleteBrandAction(id)
    Actions -> Model: deleteBrand(id)
    Model -> DB: DELETE
    Actions --> Page: { success }
    Page --> Admin: Refresh list
end

@enduml
